# AlphaGen: Feedback-Driven Alpha Generation

> "Automate the Routine, Preserve the Creative." - Igor Tulchinsky (CEO of WorldQuant)

AlphaGen is a powerful, feedback-driven pipeline that combines the generative capabilities of Google's Gemini Models with the rigorous backtesting environment of the WorldQuant BRAIN Platform. It automates the cycle of generating, testing, and iteratively refining quantitative trading signals (Alphas), allowing researchers to focus on high-level strategy and intuition.

![pnl_chart.png](https://i.ibb.co/Pvb5pzQY/image.png)
*(Example PnL Chart generated by the pipeline)*

---

## üìã Table of Contents

- [Core Concept](#-core-concept)
- [Features](#-features)
- [Workflow](#-workflow)
- [Getting Started](#-getting-started)
  - [Prerequisites](#prerequisites)
  - [Installation](#installation)
  - [Configuration](#configuration)
- [Usage](#-usage)
- [Project Structure](#-project-structure)
- [Configuration Details](#-configuration-details)
- [Contributing](#-contributing)
- [License](#-license)

---

## üí° Core Concept

In Quantitative Finance, the process of developing a new Alpha is often a manual, iterative process:
1.  **Hypothesize:** Formulate an economic or quantitative hypothesis.
2.  **Implement:** Code the hypothesis as a mathematical expression.
3.  **Backtest:** Simulate its performance on historical data.
4.  **Analyze:** Study the results (sharpe, fitness, turnover, etc.).
5.  **Refine:** Tweak the expression based on the analysis and repeat.

AlphaGen automates steps 2 through 5. It uses the Gemini API to handle the creative implementation and refinement, and the WorldQuant BRAIN API to perform the routine backtesting and analysis. The results from each simulation are programmatically analyzed and fed back to Gemini as context, enabling it to make informed improvements in the next iteration.

## ‚ú® Features

-   **Automated Alpha Generation:** Leverages the Gemini API to generate novel Alpha Expressions based on an Initial Prompt and Data Field Descriptions.
-   **Seamless BRAIN Integration:** A dedicated API client (`brain.py`) handles authentication, simulation submission, and results retrieval from the WorldQuant BRAIN platform.
-   **Iterative Refinement Loop:** Automatically feeds simulation results back to the model, allowing it to learn from its mistakes and improve the alpha over multiple iterations.
-   **Rich Performance Feedback:** Goes beyond basic metrics by calculating custom factors like `Alpha Quality Factor`, `Turnover Stability`, and `Sub-Universe Robustness` to provide a nuanced view of the Alpha's performance.
-   **Highly Configurable:** Easily adjust simulation parameters, AI model settings, and prompts via a central `config.py` file.
-   **Visual PnL Chart Generation:** Automatically creates and saves a PnL chart for each successful simulation, providing a quick visual reference of performance.
-   **Session & Context Persistence:** Saves all simulation results and the full conversation context for each run, allowing for easy review and debugging.

## üîÑ Workflow

The core of AlphaGen is a continuous feedback loop between the generative model and the backtesting engine.

![UML Diagram](https://i.ibb.co/Xkr6XWtz/image.png)

1.  **Initialization:** The `feedback.py` script starts by loading configuration, system prompts, and logging into the BRAIN Platform.
2.  **Generation:** An initial prompt (containing simulation settings and data field descriptions) is sent to the Gemini API.
3.  **Simulation:** Gemini returns a structured Alpha Expression, which is immediately sent to the BRAIN API for simulation.
4.  **Analysis:** The script polls for the simulation results. Once complete, `processing.py` and `feedback.py` calculate Key Performance Indicators (KPIs) and format them into a concise text summary.
5.  **Feedback:** This summary is appended to the conversation history as a "user" message, providing direct feedback to the model on its last attempt.
6.  **Iteration:** The entire conversation history is sent back to Gemini, which uses the new feedback to generate a revised alpha. The cycle repeats for a configured number of iterations.

## üöÄ Getting Started

Follow these steps to get AlphaGen up and running on your local machine.

### Prerequisites

-   Python 3.8+
-   A WorldQuant BRAIN account
-   A Google AI Studio API Key for Gemini

### Installation

1.  **Clone the repository:**
    ```bash
    git clone https://github.com/MiracleInvoker/AlphaGen.git
    cd AlphaGen
    ```

2.  **Create a virtual environment (recommended):**
    ```bash
    python -m venv venv
    source venv/bin/activate  # On Windows, use `venv\Scripts\activate`
    ```

3.  **Install the dependencies**

### Configuration

1.  **Create a `.env` file** in the root of the project by copying the example:
    ```bash
    cp .env.example .env
    ```

2.  **Edit the `.env` file** with your credentials:
    ```env
    # WorldQuant BRAIN Credentials
    email="your-brain-email@example.com"
    password="your-brain-password"
    
    # Session cookie (optional, will be auto-populated on first login)
    t="" 
    
    # Google Gemini API Key(s) - can be a single key or comma-separated
    gemini_api_keys="your_gemini_api_key_here"
    ```

3.  **Review `config.py`** to adjust simulation settings, model parameters, and initial prompts to fit your research goals.

## ‚ñ∂Ô∏è Usage

Once the installation and configuration are complete, you can start the generation pipeline by running the main script:

```bash
python feedback.py
```

The script will:
-   Log into the BRAIN API.
-   Print the initial prompt to the console.
-   Begin the iterative generation and simulation loop.
-   Display model outputs and formatted simulation results in the console with rich colors.
-   Generate a `pnl_chart.png` in the root directory for each iteration.
-   Save outputs to the `simulations/` and `contexts/` directories, named with the run's timestamp.

## üìÇ Project Structure

```
.
‚îú‚îÄ‚îÄ brain.py                # WorldQuant BRAIN API client
‚îú‚îÄ‚îÄ config.py               # All user-facing configurations
‚îú‚îÄ‚îÄ feedback.py             # Main orchestration script (The core loop)
‚îú‚îÄ‚îÄ processing.py           # Helper functions for analysis and chart generation
‚îú‚îÄ‚îÄ prompts/
‚îÇ   ‚îî‚îÄ‚îÄ prompt.txt            # System prompt template for the AI model
‚îú‚îÄ‚îÄ simulations/            # Output directory for saved simulation JSON results
‚îú‚îÄ‚îÄ contexts/               # Output directory for pickled conversation contexts
‚îú‚îÄ‚îÄ .env.example            # Example environment file for credentials
‚îî‚îÄ‚îÄ pnl_chart.png           # Output PnL chart from the last iteration
```

## ‚öôÔ∏è Configuration Details

The `config.py` file is the main control panel for the pipeline.

-   **`simulation_settings`**: A dictionary containing all parameters for the BRAIN simulation (e.g., `region`, `universe`, `neutralization`).
-   **`data_fields`**: A list of data fields you want the model to be aware of. Their descriptions will be fetched from BRAIN and included in the initial prompt.
-   **`model`**: The Gemini model to use (e.g., `gemini-1.5-pro`).
-   **`temperature`**: Controls the creativity of the model. Higher values (e.g., `1.0`) lead to more diverse but potentially less stable results.
-   **`system_prompt_file`**: Path to the file containing the core instructions for the AI model.
-   **`operators_file`**: Path to a file listing available operators in BRAIN's expression language, which is injected into the system prompt.
-   **`max_iterations`**: The number of refinement cycles to run.
-   **`structured_output_schema`**: Defines the JSON format that Gemini is forced to respond with, ensuring reliable parsing of its output.

## ü§ù Contributing

Contributions are welcome! If you have ideas for new features, improvements, or bug fixes, please feel free to:
1.  Fork the repository.
2.  Create a new feature branch (`git checkout -b feature/AmazingFeature`).
3.  Commit your changes (`git commit -m 'Add some AmazingFeature'`).
4.  Push to the branch (`git push origin feature/AmazingFeature`).
5.  Open a Pull Request.

## üìú License

This project is licensed under the Apace License 2.0. See the `LICENSE` file for details.
